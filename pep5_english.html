<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CAT English Lab - PEP 5é«˜æ•ˆå¤ä¹ </title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        :root {
            --primary-color: #64B5F6;
            --secondary-color: #FFB74D;
            --success-color: #81C784;
            --danger-color: #E57373;
            --bg-color: #F0F4F8;
            --card-shadow: 0 10px 20px rgba(0,0,0,0.05);
        }

        body {
            background-color: var(--bg-color);
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            color: #37474F;
            padding-bottom: 80px;
        }

        .header {
            background: linear-gradient(135deg, #4FC3F7, #2196F3);
            color: white;
            padding: 3rem 0;
            text-align: center;
            border-bottom-left-radius: 50px;
            border-bottom-right-radius: 50px;
            margin-bottom: 2rem;
            box-shadow: 0 4px 15px rgba(33, 150, 243, 0.3);
        }

        .nav-pills .nav-link {
            border-radius: 30px;
            padding: 12px 25px;
            font-weight: 600;
            color: #546E7A;
            transition: all 0.3s;
            background: white;
            margin: 5px;
            box-shadow: var(--card-shadow);
        }

        .nav-pills .nav-link.active {
            background-color: var(--primary-color);
            transform: scale(1.05);
        }

        /* å•è¯å¡ç‰‡æ ·å¼ */
        .flashcard {
            height: 160px;
            perspective: 1000px;
            cursor: pointer;
            margin-bottom: 20px;
        }

        .flashcard-inner {
            position: relative;
            width: 100%;
            height: 100%;
            text-align: center;
            transition: transform 0.6s;
            transform-style: preserve-3d;
            box-shadow: var(--card-shadow);
            border-radius: 20px;
        }

        .flashcard.flipped .flashcard-inner {
            transform: rotateY(180deg);
        }

        .flashcard-front, .flashcard-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 15px;
            border-radius: 20px;
            background: white;
        }

        .flashcard-back {
            transform: rotateY(180deg);
            background-color: var(--primary-color);
            color: white;
        }

        .btn-speak {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            margin-top: 10px;
            transition: all 0.2s;
        }

        .btn-speak:hover { background: rgba(255,255,255,0.4); transform: scale(1.1); }

        /* ä½œæ–‡æ‹¼å›¾æ ·å¼ */
        .puzzle-container {
            background: white;
            border-radius: 25px;
            padding: 30px;
            box-shadow: var(--card-shadow);
        }

        .sentence-block {
            background: #E3F2FD;
            padding: 15px 20px;
            margin-bottom: 12px;
            border-radius: 15px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
            user-select: none;
        }

        .sentence-block:hover {
            border-color: var(--primary-color);
            background: #BBDEFB;
        }

        .sentence-block.correct {
            background: #C8E6C9;
            border-color: #81C784;
            cursor: default;
        }

        /* å£è¯­å¤§ä½œæˆ˜æ ·å¼ */
        .oral-card {
            background: white;
            border-radius: 30px;
            padding: 40px;
            text-align: center;
            box-shadow: var(--card-shadow);
            min-height: 400px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .question-text {
            font-size: 1.8rem;
            color: #1976D2;
            font-weight: bold;
            margin-bottom: 30px;
        }

        .sample-answer {
            background: #FFF9C4;
            padding: 20px;
            border-radius: 20px;
            margin-top: 20px;
            display: none;
            border-left: 8px solid var(--secondary-color);
        }

        /* å°ä¸¸å­æŒ‚ä»¶ */
        .maruko-mascot {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            cursor: pointer;
            transition: all 0.3s;
        }

        .maruko-mascot:hover { transform: scale(1.1) rotate(-5deg); }

        .feedback-pop {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 2000;
            font-size: 5rem;
            display: none;
        }

        .score-badge {
            background: #FFD54F;
            color: #F57C00;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 1.2rem;
        }

        .filter-btn {
            border-radius: 20px;
            margin: 2px;
            font-size: 0.85rem;
        }

        .leaderboard-table tr {
            background: white;
            margin-bottom: 10px;
            display: block;
            border-radius: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            padding: 10px;
        }
    </style>
</head>
<body>

<div id="feedback-pop" class="feedback-pop animate__animated">ğŸ‰</div>

<div class="header">
    <div class="container">
        <h1 class="display-4 fw-bold animate__animated animate__bounceIn">ğŸŒŸ CAT English Lab</h1>
        <p class="lead">å¬å¾—è§ï¼Œè¯´å¾—å‡ºï¼Œå†™å¾—å¥½ï¼</p>
        <div class="mt-3">
            <button id="btn-unlock" class="btn btn-light rounded-pill px-4 shadow-sm" onclick="unlockAudio()">
                ğŸ”Š ç‚¹å‡»å¯ç”¨è¯­éŸ³ (å®‰å“/è‹¹æœé€šç”¨)
            </button>
        </div>
    </div>
</div>

<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div class="score-badge shadow-sm">
            â­ ç§¯åˆ†: <span id="user-score">0</span>
        </div>
        <div id="current-user" class="fw-bold text-primary" onclick="setName()">
            ğŸ‘¤ <span id="display-name">è®¾ç½®å§“å</span>
        </div>
    </div>

    <ul class="nav nav-pills mb-4 justify-content-center sticky-top bg-transparent p-2" id="mainTabs">
        <li class="nav-item"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#vocab-zone">ğŸ”¤ å…¨éƒ¨å•è¯æ£€æµ‹</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#puzzle-zone">ğŸ§© ä½œæ–‡æ‹¼å›¾</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#oral-zone">ğŸ¤ é—®ç­”é¢˜æŒ‘æˆ˜</button></li>
    </ul>

    <div class="tab-content">
        <!-- å•è¯æ¿å— -->
        <div class="tab-pane fade show active" id="vocab-zone">
            <div class="row mb-3">
                <div class="col-12 text-center">
                    <div class="btn-group mb-3 flex-wrap">
                        <button class="btn btn-outline-primary filter-btn active" onclick="filterVocab('all', this)">å…¨éƒ¨</button>
                        <button class="btn btn-outline-primary filter-btn" onclick="filterVocab(1, this)">Unit 1</button>
                        <button class="btn btn-outline-primary filter-btn" onclick="filterVocab(2, this)">Unit 2</button>
                        <button class="btn btn-outline-primary filter-btn" onclick="filterVocab(3, this)">Unit 3</button>
                        <button class="btn btn-outline-primary filter-btn" onclick="filterVocab(4, this)">Unit 4</button>
                        <button class="btn btn-outline-primary filter-btn" onclick="filterVocab(5, this)">Unit 5</button>
                        <button class="btn btn-outline-primary filter-btn" onclick="filterVocab(6, this)">Unit 6</button>
                    </div>
                    <div class="d-flex justify-content-center gap-2 mb-4">
                        <input type="text" class="form-control rounded-pill shadow-sm" style="max-width: 400px;" id="vocabSearch" placeholder="ğŸ” æœç´¢å•è¯æˆ–ä¸­æ–‡..." onkeyup="searchVocab()">
                        <button class="btn btn-secondary rounded-pill" onclick="toggleVocabMode(this)">ğŸ™ˆ éšè—è‹±æ–‡ (æ£€æµ‹æ¨¡å¼)</button>
                    </div>
                </div>
            </div>
            <div class="row" id="vocab-list">
                <!-- å•è¯å¡ç‰‡åŠ¨æ€åŠ è½½ -->
            </div>
        </div>

        <!-- ä½œæ–‡æ‹¼å›¾ -->
        <div class="tab-pane fade" id="puzzle-zone">
            <div class="row justify-content-center">
                <div class="col-md-8">
                    <div class="puzzle-container">
                        <select class="form-select rounded-pill mb-4" id="composition-select" onchange="loadComposition()">
                            <option value="">-- è¯·é€‰æ‹©ä¸€ç¯‡ä½œæ–‡å¼€å§‹æ‹¼å›¾ --</option>
                        </select>
                        <div id="puzzle-board">
                            <p class="text-muted text-center py-5">è¯·å…ˆé€‰æ‹©ä½œæ–‡é¢˜ç›®ï¼Œå¼€å§‹é€»è¾‘æ‹¼å›¾æŒ‘æˆ˜ï¼</p>
                        </div>
                        <div id="puzzle-result" class="mt-4" style="display:none;">
                            <h5 class="text-success fw-bold">æ­å–œï¼æ‹¼å›¾æˆåŠŸï¼ğŸ‰</h5>
                            <button class="btn btn-primary rounded-pill mt-2" onclick="readFullComposition()">ğŸ”Š å…¨æ–‡æœ—è¯»å¹¶åŠ åˆ†</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- å£è¯­å¤§ä½œæˆ˜ -->
        <div class="tab-pane fade" id="oral-zone">
            <div class="row justify-content-center">
                <div class="col-md-8">
                    <div class="oral-card animate__animated animate__fadeIn">
                        <div id="oral-game-start">
                            <h3>ğŸ¤ å£è¯­é—®ç­”æŒ‘æˆ˜ (20é¢˜)</h3>
                            <p class="text-muted mb-4">å¬é—®é¢˜ï¼Œå¤§å£°è¯´å‡ºä½ çš„ç­”æ¡ˆï¼Œç‚¹å‡»æŸ¥çœ‹å‚è€ƒèŒƒä¾‹ã€‚</p>
                            <button class="btn btn-primary btn-lg rounded-pill px-5" onclick="startOralChallenge()">å¼€å§‹æŒ‘æˆ˜</button>
                        </div>
                        <div id="oral-game-play" style="display:none;">
                            <div class="progress mb-4" style="height: 10px;">
                                <div id="oral-progress" class="progress-bar bg-success" role="progressbar" style="width: 0%"></div>
                            </div>
                            <div class="question-text" id="current-question">Question Text Here</div>
                            <div class="d-grid gap-3 d-sm-block">
                                <button class="btn btn-info btn-lg rounded-pill text-white px-4 me-sm-2" onclick="hearQuestion()">ğŸ”Š å¬é—®é¢˜</button>
                                <button class="btn btn-warning btn-lg rounded-pill text-white px-4" onclick="showOralAnswer()">ğŸ’¡ çœ‹å‚è€ƒç­”æ¡ˆ</button>
                            </div>
                            <div class="sample-answer animate__animated animate__fadeIn" id="oral-sample">
                                <p class="mb-2 fw-bold text-secondary">å‚è€ƒç­”æ¡ˆï¼š</p>
                                <h4 id="sample-text">Sample Answer Here</h4>
                                <button class="btn btn-sm btn-outline-primary rounded-pill mt-2" onclick="hearAnswer()">ğŸ”Š å¬å‘éŸ³</button>
                            </div>
                            <div class="mt-5">
                                <button class="btn btn-success btn-lg rounded-pill px-5" onclick="nextOralQuestion()">âœ… æˆ‘ç­”å¯¹äº†ï¼Œä¸‹ä¸€é¢˜</button>
                            </div>
                        </div>
                        <div id="oral-game-end" style="display:none;">
                            <h2 class="text-success mb-3">å¤ªæ£’äº†ï¼</h2>
                            <p>ä½ å®Œæˆäº†å£è¯­å¤§ä½œæˆ˜ï¼Œè·å¾—äº†å¤§é‡ç§¯åˆ†ï¼</p>
                            <button class="btn btn-outline-primary rounded-pill px-4" onclick="startOralChallenge()">å†æ¬¡æŒ‘æˆ˜</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        </div>
    </div>
</div>

<div class="maruko-mascot animate__animated animate__bounceIn" onclick="marukoTalk()">
    <img src="https://img.icons8.com/color/96/anime.png" alt="Maruko">
</div>

<audio id="sfx-correct" src="https://assets.mixkit.co/active_storage/sfx/2013/2013-preview.mp3"></audio>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // --- æ•°æ®å®šä¹‰ ---
    const allWords = [
        {unit:1, en:'old', cn:'è€çš„'}, {unit:1, en:'young', cn:'å¹´è½»çš„'}, {unit:1, en:'funny', cn:'æ»‘ç¨½çš„'}, 
        {unit:1, en:'kind', cn:'å’Œè”¼çš„'}, {unit:1, en:'strict', cn:'ä¸¥å‰çš„'}, {unit:1, en:'polite', cn:'æœ‰ç¤¼è²Œçš„'},
        {unit:1, en:'helpful', cn:'æœ‰å¸®åŠ©çš„'}, {unit:1, en:'shy', cn:'ç¾æ€¯çš„'}, {unit:1, en:'hard-working', cn:'å‹¤å¥‹çš„'},
        {unit:1, en:'clever', cn:'èªæ˜çš„'},
        {unit:2, en:'Monday', cn:'æ˜ŸæœŸä¸€'}, {unit:2, en:'Tuesday', cn:'æ˜ŸæœŸäºŒ'}, {unit:2, en:'Wednesday', cn:'æ˜ŸæœŸä¸‰'},
        {unit:2, en:'Thursday', cn:'æ˜ŸæœŸå››'}, {unit:2, en:'Friday', cn:'æ˜ŸæœŸäº”'}, {unit:2, en:'Saturday', cn:'æ˜ŸæœŸå…­'},
        {unit:2, en:'Sunday', cn:'æ˜ŸæœŸæ—¥'}, {unit:2, en:'weekend', cn:'å‘¨æœ«'}, {unit:2, en:'wash my clothes', cn:'æ´—è¡£æœ'},
        {unit:2, en:'watch TV', cn:'çœ‹ç”µè§†'}, {unit:2, en:'do homework', cn:'åšä½œä¸š'}, {unit:2, en:'read books', cn:'çœ‹ä¹¦'},
        {unit:2, en:'play football', cn:'è¸¢è¶³çƒ'}, {unit:2, en:'often', cn:'ç»å¸¸'},
        {unit:3, en:'sandwich', cn:'ä¸‰æ˜æ²»'}, {unit:3, en:'hamburger', cn:'æ±‰å ¡åŒ…'}, {unit:3, en:'salad', cn:'æ²™æ‹‰'},
        {unit:3, en:'tea', cn:'èŒ¶'}, {unit:3, en:'ice cream', cn:'å†°æ·‡æ·‹'}, {unit:3, en:'fresh', cn:'æ–°é²œçš„'},
        {unit:3, en:'healthy', cn:'å¥åº·çš„'}, {unit:3, en:'delicious', cn:'ç¾å‘³çš„'}, {unit:3, en:'hot', cn:'è¾£çš„'},
        {unit:3, en:'sweet', cn:'ç”œçš„'}, {unit:3, en:'thirsty', cn:'å£æ¸´çš„'}, {unit:3, en:'favorite', cn:'æœ€å–œçˆ±çš„'},
        {unit:4, en:'sing', cn:'å”±'}, {unit:4, en:'dance', cn:'è·³èˆ'}, {unit:4, en:'kung fu', cn:'åŠŸå¤«'},
        {unit:4, en:'cook', cn:'çƒ¹è°ƒ'}, {unit:4, en:'swim', cn:'æ¸¸æ³³'}, {unit:4, en:'draw', cn:'ç”»'},
        {unit:4, en:'cartoon', cn:'æ¼«ç”»'}, {unit:4, en:'ping-pong', cn:'ä¹’ä¹“çƒ'}, {unit:4, en:'basketball', cn:'ç¯®çƒ'},
        {unit:4, en:'English songs', cn:'è‹±è¯­æ­Œæ›²'},
        {unit:5, en:'clock', cn:'æ—¶é’Ÿ'}, {unit:5, en:'plant', cn:'æ¤ç‰©'}, {unit:5, en:'bottle', cn:'ç“¶å­'},
        {unit:5, en:'water bottle', cn:'æ°´ç“¶'}, {unit:5, en:'bike', cn:'è‡ªè¡Œè½¦'}, {unit:5, en:'photo', cn:'ç…§ç‰‡'},
        {unit:5, en:'front', cn:'å‰é¢'}, {unit:5, en:'in front of', cn:'åœ¨...å‰é¢'}, {unit:5, en:'between', cn:'åœ¨...ä¹‹é—´'},
        {unit:5, en:'above', cn:'åœ¨...ä¸Šé¢'}, {unit:5, en:'beside', cn:'åœ¨...æ—è¾¹'}, {unit:5, en:'behind', cn:'åœ¨...åé¢'},
        {unit:6, en:'forest', cn:'æ£®æ—'}, {unit:6, en:'river', cn:'æ²³æµ'}, {unit:6, en:'lake', cn:'æ¹–æ³Š'},
        {unit:6, en:'mountain', cn:'é«˜å±±'}, {unit:6, en:'hill', cn:'å°å±±'}, {unit:6, en:'tree', cn:'æ ‘æœ¨'},
        {unit:6, en:'bridge', cn:'æ¡¥'}, {unit:6, en:'building', cn:'å»ºç­‘ç‰©'}, {unit:6, en:'village', cn:'æ‘åº„'},
        {unit:6, en:'house', cn:'æˆ¿å±‹'}
    ];

    const allCompositions = [
        {
            title: "Introducing Myself (äº¤å‹ï¼šä»‹ç»è‡ªå·±)",
            sentences: [
                "Dear Betty, How are you?",
                "I want to be your friend.",
                "I'm Jim. I'm eleven years old.",
                "I'm tall and thin. I'm hard-working.",
                "I can do some kung fu and play basketball.",
                "I often do some kung fu on the weekend.",
                "My favourite food is dumplings. They're delicious.",
                "My favourite drink is tea. How about you?",
                "Yours, Jim"
            ]
        },
        {
            title: "Weekend Activities (äº¤å‹ï¼šä»‹ç»å‘¨æœ«æ´»åŠ¨)",
            sentences: [
                "Dear Amy, Hello, I'm Lucy.",
                "I don't go to school on the weekend.",
                "I often have an art class on Saturdays.",
                "I like drawing pictures.",
                "I often go to the park with my parents on Sundays.",
                "We often have a picnic there.",
                "I'm always happy. I like my weekend.",
                "Yours, Lucy"
            ]
        },
        {
            title: "The Nature Park (æè¿°è‡ªç„¶å…¬å›­)",
            sentences: [
                "There is a nature park near my home.",
                "There are many hills and a long river in the nature park.",
                "There is a bridge over the river.",
                "There are some ducks on the river.",
                "We can go boating on the river.",
                "There are many trees beside the river.",
                "What a beautiful nature park!"
            ]
        },
        {
            title: "My Bedroom (äº¤å‹ï¼šä»‹ç»è‡ªå·±çš„æˆ¿é—´)",
            sentences: [
                "Dear Sally, This is my bedroom.",
                "It's small but nice.",
                "There is a small bed, a desk and a chair.",
                "There is a clock on the wall.",
                "There is a doll on my bed.",
                "There are some books and a photo on the shelf.",
                "There is a computer and a plant on the desk.",
                "My bag is on the floor.",
                "I often read books in my bedroom.",
                "I like my bedroom very much.",
                "Yours, Rita"
            ]
        },
        {
            title: "My Favourite Teacher (æè¿°æœ€å–œçˆ±çš„è€å¸ˆ)",
            sentences: [
                "Hello, I'm Tom.",
                "I have many teachers at school.",
                "But my favourite teacher is Mr Liu.",
                "Mr Liu is my PE teacher. He has big eyes.",
                "He is tall and thin. He is young.",
                "He likes playing sports. He is nice.",
                "I like him very much."
            ]
        },
        {
            title: "My Weekend (ä»‹ç»å‘¨æœ«çš„æ´»åŠ¨)",
            sentences: [
                "I'm always busy on the weekend.",
                "On Saturdays, I often do my homework in the morning.",
                "In the afternoon, I often play football with my friends in the park.",
                "On Sundays, I usually visit my grandparents in the morning and watch TV with my parents in the afternoon.",
                "I like my weekends."
            ]
        }
    ];

    const allQuestions = [
        {q: "What's the robot like?", a: "It's very clever and helpful."},
        {q: "Are there any robots in your home?", a: "Yes, there are. / No, there aren't."},
        {q: "What can the robot do?", a: "It can speak English and clean the room."},
        {q: "Is there a river in your hometown?", a: "Yes, there is. / No, there isn't."},
        {q: "What's in the nature park?", a: "There is a lake and many trees."},
        {q: "What's in your living room?", a: "There is a big sofa and a clock."},
        {q: "Where is your schoolbag?", a: "It's on the desk."},
        {q: "What can you do for the party?", a: "I can sing English songs."},
        {q: "What's your favorite sport?", a: "My favorite sport is football."},
        {q: "What's your favorite food?", a: "My favorite food is salad."},
        {q: "What's your favorite drink?", a: "My favorite drink is milk."},
        {q: "Can your father swim?", a: "Yes, he can. / No, he can't."},
        {q: "What do you often do on the weekend?", a: "I often wash my clothes and watch TV."},
        {q: "What would you like for lunch?", a: "I'd like some beef and rice."},
        {q: "How many subjects do you have at school?", a: "I have six subjects."},
        {q: "What do you have on Thursdays?", a: "I have maths, English and music."},
        {q: "What's your favorite day?", a: "My favorite day is Friday."},
        {q: "Are you helpful at home?", a: "Yes, I am. I can clean the bedroom."},
        {q: "What are you like?", a: "I'm shy and kind."},
        {q: "What is your mother like?", a: "She is hard-working and strict."}
    ];

    // --- çŠ¶æ€ç®¡ç† ---
    let state = {
        score: parseInt(localStorage.getItem('pep5_score')) || 0,
        userName: localStorage.getItem('pep5_user') || 'è®¿å®¢',
        currentPuzzle: null,
        puzzleOrder: [],
        oralIndex: 0,
        oralQueue: [],
        vocabTestMode: false
    };

    // --- æ ¸å¿ƒè¯­éŸ³åŠŸèƒ½ (å®‰å“/è‹¹æœé€‚é…) ---
    function unlockAudio() {
        speak("Welcome to the English Lab!");
        document.getElementById('btn-unlock').classList.add('d-none');
    }

    let voiceInterval;
    function speak(text) {
        if (!window.speechSynthesis) {
            alert("æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³åŠŸèƒ½");
            return;
        }
        
        // åœæ­¢ä¹‹å‰çš„è®¡æ—¶å™¨
        if (voiceInterval) clearInterval(voiceInterval);
        
        // å¼ºåˆ¶å–æ¶ˆæ­£åœ¨æ’­æ”¾çš„è¯­éŸ³
        window.speechSynthesis.cancel();
        
        // å»¶è¿Ÿä¸€å°ä¼šå„¿å†æ’­æ”¾ï¼Œç»™æµè§ˆå™¨å–˜æ¯æ—¶é—´
        setTimeout(() => {
            const utter = new SpeechSynthesisUtterance(text);
            utter.lang = 'en-US';
            utter.rate = 0.85;
            utter.pitch = 1.0;
            
            // å…³é”®ä¿®å¤ï¼šiOS/Safari å¿…é¡»åœ¨ç”¨æˆ·äº¤äº’åè§¦å‘ï¼Œä¸”å®¹æ˜“å› ä¸ºé•¿æ–‡æœ¬ä¸­æ–­
            window.speechSynthesis.speak(utter);
            
            // è§£å†³ç§»åŠ¨ç«¯é™é»˜ä¸­æ–­é—®é¢˜çš„ç»ˆææ–¹æ¡ˆï¼šæ¯2ç§’æ£€æŸ¥å¹¶ç»´æŒæ’­æ”¾çŠ¶æ€
            voiceInterval = setInterval(() => {
                if (!window.speechSynthesis.speaking) {
                    clearInterval(voiceInterval);
                } else {
                    // ä»…åœ¨ä»ç„¶æ’­æ”¾æ—¶è¿›è¡Œå¾®å°çš„æš‚åœæ¢å¤ï¼Œä¿æŒè¿æ¥
                    window.speechSynthesis.pause();
                    window.speechSynthesis.resume();
                }
            }, 2000);
        }, 50);
    }

    // --- åŸºç¡€ UI åŠŸèƒ½ ---
    function updateScore(points) {
        state.score += points;
        document.getElementById('user-score').innerText = state.score;
        localStorage.setItem('pep5_score', state.score);
        showFeedback();
    }

    function showFeedback() {
        const pop = document.getElementById('feedback-pop');
        pop.style.display = 'block';
        pop.classList.add('animate__bounceIn');
        document.getElementById('sfx-correct').play();
        setTimeout(() => {
            pop.style.display = 'none';
            pop.classList.remove('animate__bounceIn');
        }, 1000);
    }

    function setName() {
        const n = prompt("è¾“å…¥ä½ çš„æŒ‘æˆ˜å§“åï¼š", state.userName);
        if (n) {
            state.userName = n;
            document.getElementById('display-name').innerText = n;
            localStorage.setItem('pep5_user', n);
        }
    }

    // --- å•è¯æ¿å—é€»è¾‘ ---
    function renderVocab(list) {
        const container = document.getElementById('vocab-list');
        container.innerHTML = list.map(w => `
            <div class="col-6 col-md-3 animate__animated animate__fadeIn">
                <div class="flashcard ${state.vocabTestMode ? '' : 'flipped'}" onclick="this.classList.toggle('flipped')">
                    <div class="flashcard-inner">
                        <div class="flashcard-front">
                            <span class="badge bg-light text-primary mb-2">Unit ${w.unit}</span>
                            <h5>${w.cn}</h5>
                        </div>
                        <div class="flashcard-back">
                            <h4>${w.en}</h4>
                            <button class="btn-speak" onclick="event.stopPropagation(); speak('${w.en}')">
                                <i class="bi bi-volume-up-fill"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `).join('');
    }

    function toggleVocabMode(btn) {
        state.vocabTestMode = !state.vocabTestMode;
        btn.innerHTML = state.vocabTestMode ? 'ğŸ‘ï¸ æ˜¾ç¤ºè‹±æ–‡ (å­¦ä¹ æ¨¡å¼)' : 'ğŸ™ˆ éšè—è‹±æ–‡ (æ£€æµ‹æ¨¡å¼)';
        btn.classList.toggle('btn-secondary');
        btn.classList.toggle('btn-primary');
        const unitBtn = document.querySelector('.filter-btn.active');
        const unit = unitBtn.innerText.includes('Unit') ? parseInt(unitBtn.innerText.split(' ')[1]) : 'all';
        filterVocab(unit, unitBtn);
    }

    function filterVocab(unit, btn) {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        const filtered = unit === 'all' ? allWords : allWords.filter(w => w.unit === unit);
        renderVocab(filtered);
    }

    function searchVocab() {
        const q = document.getElementById('vocabSearch').value.toLowerCase();
        const filtered = allWords.filter(w => w.en.toLowerCase().includes(q) || w.cn.includes(q));
        renderVocab(filtered);
    }

    // --- ä½œæ–‡æ‹¼å›¾é€»è¾‘ ---
    function loadComposition() {
        const idx = document.getElementById('composition-select').value;
        if (idx === "") return;
        
        state.currentPuzzle = allCompositions[idx];
        state.puzzleOrder = [];
        document.getElementById('puzzle-result').style.display = 'none';
        
        // æ‰“ä¹±å¥å­
        const shuffled = [...state.currentPuzzle.sentences].sort(() => Math.random() - 0.5);
        
        const board = document.getElementById('puzzle-board');
        board.innerHTML = `
            <h5 class="mb-4 text-primary">é¢˜ç›®ï¼š${state.currentPuzzle.title}</h5>
            <div id="sentences-pool">
                ${shuffled.map((s, i) => `
                    <div class="sentence-block shadow-sm" id="s-${i}" onclick="pickSentence('${s.replace(/'/g, "\\'")}', 's-${i}')">
                        ${s}
                    </div>
                `).join('')}
            </div>
            <hr>
            <div id="puzzle-answer" class="p-3 border rounded-4 bg-light min-vh-20">
                <p class="text-muted small">ç‚¹å‡»ä¸Šæ–¹å¥å­ï¼ŒæŒ‰æ­£ç¡®é¡ºåºæ’åˆ—...</p>
            </div>
        `;
    }

    function pickSentence(text, id) {
        const block = document.getElementById(id);
        if (block.classList.contains('correct')) return;

        const expected = state.currentPuzzle.sentences[state.puzzleOrder.length];
        if (text === expected) {
            state.puzzleOrder.push(text);
            block.classList.add('correct', 'animate__pulse');
            document.getElementById('puzzle-answer').innerHTML += `<div class="p-2 mb-2 bg-white rounded shadow-sm text-success fw-bold animate__animated animate__fadeInLeft">âœ… ${text}</div>`;
            speak(text);
            
            if (state.puzzleOrder.length === state.currentPuzzle.sentences.length) {
                document.getElementById('puzzle-result').style.display = 'block';
                updateScore(10);
            }
        } else {
            block.classList.add('animate__shakeX', 'bg-danger', 'text-white');
            setTimeout(() => block.classList.remove('animate__shakeX', 'bg-danger', 'text-white'), 500);
            speak("Try again");
        }
    }

    function readFullComposition() {
        const fullText = state.currentPuzzle.sentences.join(' ');
        speak(fullText);
        updateScore(5);
    }

    // --- å£è¯­æŒ‘æˆ˜é€»è¾‘ ---
    function startOralChallenge() {
        state.oralQueue = [...allQuestions].sort(() => Math.random() - 0.5);
        state.oralIndex = 0;
        document.getElementById('oral-game-start').style.display = 'none';
        document.getElementById('oral-game-end').style.display = 'none';
        document.getElementById('oral-game-play').style.display = 'block';
        showOralQuestion();
    }

    function showOralQuestion() {
        const q = state.oralQueue[state.oralIndex];
        document.getElementById('current-question').innerText = q.q;
        document.getElementById('oral-sample').style.display = 'none';
        document.getElementById('oral-progress').style.width = `${(state.oralIndex / state.oralQueue.length) * 100}%`;
        speak(q.q);
    }

    function hearQuestion() {
        speak(state.oralQueue[state.oralIndex].q);
    }

    function showOralAnswer() {
        const q = state.oralQueue[state.oralIndex];
        document.getElementById('sample-text').innerText = q.a;
        document.getElementById('oral-sample').style.display = 'block';
    }

    function hearAnswer() {
        speak(state.oralQueue[state.oralIndex].a);
    }

    function nextOralQuestion() {
        updateScore(5);
        state.oralIndex++;
        if (state.oralIndex < state.oralQueue.length) {
            showOralQuestion();
        } else {
            document.getElementById('oral-game-play').style.display = 'none';
            document.getElementById('oral-game-end').style.display = 'block';
            updateScore(50); // é€šå…³å¥–åŠ±
        }
    }

    function marukoTalk() {
        const msgs = ["ä»Šå¤©ä¹Ÿè¦åŠ æ²¹å“¦ï¼", "ä½ æ˜¯æœ€æ£’çš„ï¼", "å¤šå¬å¤šè¯´ï¼Œè‹±è¯­å°±ä¼šå˜å¥½ï¼", "åˆ«å¿˜äº†ç‚¹äº®ä½ çš„æ˜Ÿæ˜Ÿï¼"];
        const msg = msgs[Math.floor(Math.random() * msgs.length)];
        alert("å°ä¸¸å­è¯´ï¼š" + msg);
    }

    // --- åˆå§‹åŒ– ---
    window.onload = () => {
        document.getElementById('display-name').innerText = state.userName;
        document.getElementById('user-score').innerText = state.score;
        
        // åŠ è½½ä½œæ–‡é€‰é¡¹
        const compSelect = document.getElementById('composition-select');
        allCompositions.forEach((c, i) => {
            const opt = document.createElement('option');
            opt.value = i;
            opt.innerText = c.title;
            compSelect.appendChild(opt);
        });

        renderVocab(allWords);
    };
</script>

</body>
</html>
